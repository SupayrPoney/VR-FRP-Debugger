<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
    VaRken Debugger
    </title>
    <meta name="description" content="Hello, World! - A-Frame">
    <link rel="stylesheet" type="text/css" href="stylesheet.css">
    <script src="https://aframe.io/releases/0.3.2/aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.3.1/dist/aframe-extras.misc.min.js"></script><!-- For controllers -->
    <script src="https://rawgit.com/bryik/aframe-bmfont-text-component/master/dist/aframe-bmfont-text-component.min.js"></script>
    <script src="https://rawgit.com/andreasplesch/aframe-meshline-component/master/dist/aframe-meshline-component.min.js"></script>
    <script src="https://rawgit.com/ngokevin/aframe-animation-component/master/dist/aframe-animation-component.min.js"></script>
    <script src="https://rawgit.com/protyze/aframe-alongpath-component/master/dist/aframe-alongpath-component.min.js"></script>
    <script src="https://rawgit.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


    <style>
        .menu {
          float:left;
          width:20%;
          height:80%;
        }
        .mainContent {
          float:left;
          width:75%;
          height:80%;
        }
    </style>

    <script type="text/javascript">
        var signalGraph = ""
        function sleep(milliseconds) {
            var start = new Date().getTime();
            for (var i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds){
                    break;
            }
          }
        }
        function findSignalNode(signalGraph, signalName) {
            function searchInNode(node, signalName) {
                // console.log(node);
                if (node.ref == signalName) {
                    return node;
                }
                else if (node.children) {
                    var i;
                    var result = null;
                    for(i = 0; result == null && i < node.children.length; i++){
                        result = searchInNode(node.children[i], signalName);
                   }
                   return result;
                }
                return null;
            }
            var i;
            var result = null;
            var keys = Object.keys(signalGraph);
            for (i = 0; result == null && i < keys.length; i++){
                // console.log(signalGraph);
                if (signalGraph[keys[i]].ref ==signalName ) {
                    result = signalGraph[keys[i]];
                }
                else{
                    result = searchInNode(signalGraph[keys[i]], signalName);
                }
            }
            return result;
        }
        function start() {

            signalGraph = JSON.parse(document.getElementById("graph").innerHTML);
            var nodeTest = document.querySelector('#\\3' + 2);
            // nodeTest.setAttribute('bmfont-text', "coucou");

            /*if (typeof(Worker) !== "undefined") {
                if (typeof(w) == "undefined") {
                    w = new Worker("webworker.js");
                } 
            }*/
            handle_signals(signalGraph);
        }

        var secondSignalEnabled = true;
        var signal = "seconds";

        function updateNode(node){
            function render(color) {
                // requestAnimationFrame(render);
                circle.setAttribute('color', color);
            }
            var sceneEl = document.querySelector('a-scene');
            var reached = false;

            // VALUES FLOWINGs      
            for (var i = 0; i < node.children.length; i++) {
                
                var fromNode = document.querySelector('#\\3' + node.id);
                var toNode = document.querySelector('#\\3' + node.children[i].id);

                var fromDest = fromNode.getAttribute('position');
                var toDest = toNode.getAttribute('position');

                // var newFromDest = Object.keys(fromDest).reduce(function(previous, current) {
                //     if (key != 'z') {
                //         previous[current] =  -= 4;
                //     }
                //     return previous;
                // }, {});


                // var newToDest = Object.keys(toDest).reduce(function(previous, current) {
                //     if (key != 'z') {
                //         previous[current] =  -= 4;
                //     }
                //     return previous;
                // }, {});

                
                // console.log(fromDest, toDest);
                // console.log(pathstring);
                // sleep(4000);

                var entityEl = document.createElement('a-entity');
                var dist = {
                    x:(toDest.x - fromDest.x),
                    y:(toDest.y - fromDest.y)
                }

                var division = 3;
                var deltaX = dist.x/division;
                var deltaY = dist.y/division;

                var nodeText = fromNode.getAttribute('bmfont-text').text.split("\n");
                var slidingText = nodeText[nodeText.length-1];
                // console.log(nodeText);
                entityEl.setAttribute('bmfont-text', "text:" + slidingText);
                entityEl.setAttribute('position', fromDest.x + " " + fromDest.y +" " + fromDest.z)
                entityEl.setAttribute('class', "flowing")
                // var currentPos = entityEl.getAttribute("position");
                // entityEl.addEventListener('move', function (event) {
                //     sleep(20);
                //     // console.log("yo")
                // });
                var pathstring = 'path:'
                for (var j = 0; j < division; j++) {
                    pathstring += `${fromDest.x + j*deltaX}` + "," + `${fromDest.y + j*deltaY}` + "," + `${fromDest.z} `
                }
                pathstring += `${toDest.x}` + "," + `${toDest.y}` + "," + `${toDest.z} `
                pathstring += `; closed: false; dur: 10000; loop: false`;
                entityEl.setAttribute('alongpath', pathstring);

                // for (var i = 0; i < 50; i++) {
                //     // console.log(fromDest.x-deltaX*i);
                //     entityEl.emit("move")
                    
                // }
                

                // console.log("From: ");
                // console.log(fromDest);
                // console.log("To: ");
                // console.log(toDest);
                // node.children[i];
                if (entityEl) {
                    sceneEl.appendChild(entityEl);
                }
            }
            
            var circle = document.querySelector("[id='"+ node.id + "0000"+ "']"); //#\\3' + node.id + "0000");
            // console.log(circle);//'#\\320000');// + node.id + "0000");
            render('blue');

            var nodeTest = document.querySelector('#\\3' + node.id);
            // console.log('#\\3' + node.id);
            var nodeText = nodeTest.getAttribute('bmfont-text').text;
            // console.log(nodeText.split(" ")[0]);
            var newNodeText = "text:" + node.name +'\n'+ node.value.toString();//nodeTest.setAttribute('bmfont-text',
            nodeTest.setAttribute('bmfont-text', newNodeText);


            render('black');
            // var t = 0;
            // var colors = ['black',"orange"]
            // function render() {
            //   t = 1- t;
            //   requestAnimationFrame(render);
            //   ring.setAttribute('color', colors[t]);
            // }
            // render();
        }

        function update_children(parentNode, graph){
            // console.log("Cocou",graph);
            if (parentNode.children) {
                for (var i = 0; i < parentNode.children.length; i++) {
                    node = parentNode.children[i];
                    switch(node.name){
                        case "fold":
                            node.value = eval(node.formula.replace("$$signalValue$$",parentNode.value).replace("currentValue",node.value));
                            updateNode(node);
                            break;
                        case "map":
                            [body,param] = node.formula;
                            node.value = eval(body.replace(param, parentNode.value));
                            updateNode(node);
                            break;
                        case "filter":
                            [body,param] = node.formula;
                            signalValue = parentNode.value
                            if (eval(body.replace(param, signalValue))) {
                                node.value = signalValue;
                            }
                            updateNode(node);
                            break;
                        case "merge":
                            [signal1, signal2, operator] = node.formula;
                            // console.log(signalGraph);
                            signal1Value = findSignalNode(graph,signal1).value;
                            // console.log(signal1Value)
                            signal2Value = findSignalNode(graph,signal2).value;
                            node.value = eval(signal1Value + operator + signal2Value);
                            
                            updateNode(node);
                            break;


                    }
                    update_children(node, graph);
                }
            }
        }

        function close_enough_2D(pos1,pos2) {
            return (Math.abs(pos1[0]-pos2[0]) < 0.5 && Math.abs(pos1[1]-pos2[1]) < 0.5)
        }
        
        function delete_flowing_values(argument) {


            var flowing = document.querySelectorAll(".flowing");
            for (var i = flowing.length - 1; i >= 0; i--) {
                var pathArray = flowing[i].getAttribute('alongpath').path.split(' ');
                var destination = pathArray[pathArray.length - 1].split(",");
                //console.log(destination);// Array os destination pos
                var currentPos = flowing[i].getAttribute('position');
                var currentPosArray = [currentPos.x,currentPos.y,currentPos.z];
                if (close_enough_2D(currentPosArray, destination)) {
                    flowing[i].parentNode.removeChild(flowing[i]);
                }
                //console.log(currentPos);
            }
        }

        function handle_signals(signalGraph) {
            if (secondSignalEnabled) {
                setInterval(function(){ 
                    signalGraph[signal].value ++;
                    updateNode(signalGraph[signal]);

                    // console.log(signalGraph);
                    this.update_children(signalGraph[signal], signalGraph);   
                    delete_flowing_values();
                }, 1000);
            }
        }
        function dive() {
            document.getElementById("code").style.display="none";
            document.getElementById("scene").style = null;
        }

    </script>
    <script type="text/javascript">
         $(".menu").resizable({
           handleSelector: ".splitter",
           resizeHeight: false
         });

         $(".mainContent").resizable({
           handleSelector: ".splitter-horizontal",
           resizeWidth: false
         });
    </script>

</head>
<body style="font-family:monospace" onload=start()>

    <div id="code" class="menu" contenteditable="true" >
        activate seconds<br />var mapVar = map( (a)=>(a+1) seconds)<br />fold(seconds + 0)<br />filter((a)=>(a%3==0) seconds 0)<br />var map2 = map((a)=>(a+1) mapVar)<br />merge(mapVar map2 +)

        <br />
        <button style="min-width: 100%" onclick="dive()">Dive</button>
    </div>
    <a-scene class="mainContent" style="float:right" id = "scene">
        <img id="sky_sphere-texture" src="textures/sky_sphere.jpg">
        <!-- Hands -->
        <a-entity teleport-controls hand-controls="left" aabb-collider="objects: .node;" grab if-no-vr-headset="visible: false"></a-entity>
        <a-entity teleport-controls hand-controls="right" aabb-collider="objects: .node;" grab if-no-vr-headset="visible: false"></a-entity>
        <a-sky color="#EEEEFF" material="src: #sky_sphere-texture"></a-sky>

        <a-entity id="1" bmfont-text="text:seconds
    0" color= "#333" position="2.6147500000000004 4.059857142857142 -2.5"></a-entity>
		<a-ring class= "node" id="10000" color="black" scale="0.9 0.25 2" radius-inner="0.97" position="2.9647500000000004 4.229857142857142 -2.5" radius-outer="1"></a-ring>
		<a-entity id="4" bmfont-text="text:filter
    0" color= "#333" position="-1.135275 2.777857142857143 -2.5"></a-entity>
		<a-ring class= "node" id="40000" color="black" scale="0.9 0.25 2" radius-inner="0.97" position="-0.785275 2.947857142857143 -2.5" radius-outer="1"></a-ring>
		<a-entity id="3" bmfont-text="text:fold
    0" color= "#333" position="2.6147500000000004 2.777857142857143 -2.5"></a-entity>
		<a-ring class= "node" id="30000" color="black" scale="0.9 0.25 2" radius-inner="0.97" position="2.9647500000000004 2.947857142857143 -2.5" radius-outer="1"></a-ring>
		<a-entity id="2" bmfont-text="text:map
    1" color= "#333" position="6.264749999999999 2.777857142857143 -2.5"></a-entity>
		<a-ring class= "node" id="20000" color="black" scale="0.9 0.25 2" radius-inner="0.97" position="6.614749999999999 2.947857142857143 -2.5" radius-outer="1"></a-ring>
		<a-entity id="6" bmfont-text="text:merge
    3" color= "#333" position="6.239749999999999 0.21385714285714288 -2.5"></a-entity>
		<a-ring class= "node" id="60000" color="black" scale="0.9 0.25 2" radius-inner="0.97" position="6.589749999999999 0.3838571428571429 -2.5" radius-outer="1"></a-ring>
		<a-entity id="5" bmfont-text="text:map
    2" color= "#333" position="7.41475 1.495857142857143 -2.5"></a-entity>
		<a-ring class= "node" id="50000" color="black" scale="0.9 0.25 2" radius-inner="0.97" position="7.764749999999999 1.665857142857143 -2.5" radius-outer="1"></a-ring>
		<a-entity meshline="lineWidth: 2; path: 1.9697499999999994 3.8897142857142852 -2.5,0.15625 3.2697142857142856 -2.5; color: black"></a-entity>
		<a-entity meshline="lineWidth: 2; path: 2.9647500000000004 3.8452857142857146 -2.5,2.9647500000000004 3.3322857142857143 -2.5; color: black"></a-entity>
		<a-entity meshline="lineWidth: 2; path: 3.9427499999999993 3.8862857142857146 -2.5,5.69675 3.270285714285714 -2.5; color: black"></a-entity>
		<a-entity meshline="lineWidth: 2; path: 6.247 2.570857142857143 -2.5,6.234999999999999 0.7617 -2.5; color: black"></a-entity>
		<a-entity meshline="lineWidth: 2; path: 6.9535 2.5701428571428573 -2.5,7.424250000000001 2.045285714285714 -2.5; color: black"></a-entity>
		<a-entity meshline="lineWidth: 2; path: 7.4185 1.288157142857143 -2.5,6.9375 0.7633 -2.5; color: black"></a-entity>
		
        <!-- <a-sky color="#ECECEC"></a-sky> -->
    </a-scene>
    <div id="graph" style="display: none;">
        {"name":"root","children":[],"seconds":{"name":"seconds","value":0,"ref":"seconds","id":1,"children":[{"name":"map","value":1,"formula":["a+1","a"],"id":2,"ref":"mapVar","children":[{"name":"map","value":2,"formula":["a+1","a"],"id":5,"ref":"map2","children":[{"name":"merge","value":3,"formula":["mapVar","map2","+"],"id":6,"ref":"","children":[],"parents":["mapVar","map2"]}],"parents":["mapVar"]},{"name":"merge","value":3,"formula":["mapVar","map2","+"],"id":6,"ref":"","children":[],"parents":["mapVar","map2"]}],"parents":["seconds"]},{"name":"fold","value":0,"formula":"$$signalValue$$+currentValue","id":3,"ref":"","children":[],"parents":["seconds"]},{"name":"filter","value":"0","formula":["a%3==0","a"],"id":4,"ref":"","children":[],"parents":["seconds"]}]}}
    </div>

</body>
</html>
