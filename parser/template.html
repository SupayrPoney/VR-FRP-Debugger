<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
    {{title}}
    </title>
    <meta name="description" content="Hello, World! - A-Frame">
    <link rel="stylesheet" type="text/css" href="stylesheet.css">
    <script src="https://aframe.io/releases/0.3.2/aframe.min.js"></script>
    <script src="https://rawgit.com/bryik/aframe-bmfont-text-component/master/dist/aframe-bmfont-text-component.min.js"></script>
    <script src="https://rawgit.com/andreasplesch/aframe-meshline-component/master/dist/aframe-meshline-component.min.js"></script>
    <script type="text/javascript">
        var signalGraph = ""
        function start() {
            signalGraph = JSON.parse(document.getElementById("graph").innerHTML);
            var nodeTest = document.querySelector('#\\3' + 2);
            // nodeTest.setAttribute('bmfont-text', "coucou");
            handle_signals(signalGraph);
        }

        var secondSignalEnabled = true;
        var signal = "seconds";

        function updateNode(node){
            // var t = 0;
            // var colors = ['black',"orange"]
            // function render() {
            //   t = 1- t;
            //   requestAnimationFrame(render);
            //   ring.setAttribute('color', colors[t]);
            // }
            // render();

            var nodeTest = document.querySelector('#\\3' + node.id);
            var nodeText = nodeTest.getAttribute('bmfont-text').text;
            console.log(nodeText.split(" ")[0]);
            var newNodeText = "text:" + node.name +'\n'+ node.value.toString();//nodeTest.setAttribute('bmfont-text',
            nodeTest.setAttribute('bmfont-text', newNodeText);
        }
        
        function handle_signals(signalGraph) {
            if (secondSignalEnabled) {
                setInterval(function(){ 
                    // console.log(signalGraph)
                    signalGraph[signal].value ++;
                    updateNode(signalGraph[signal]);
                    for (var i = 0; i < signalGraph.seconds.children.length; i++) {
                        node = signalGraph.seconds.children[i];
                        switch(node.name){
                            case "fold":
                                node.value = eval(node.formula.replace("$$signalValue$$",signalGraph[signal].value).replace("currentValue",node.value));
                                updateNode(node);
                                break;
                            case "map":
                                [body,param] = node.formula;
                                node.value = eval(body.replace(param, signalGraph[signal].value));
                                updateNode(node);
                                break;
                            case "filter":
                                [body,param] = node.formula;
                                signalValue = signalGraph[signal].value
                                if (eval(body.replace(param, signalValue))) {
                                    node.value = signalValue;
                                }
                                updateNode(node);
                                break;

                            // var t = 0;
                            // var colors = ['black',"orange"]
                            // function render() {
                            //   t = 1- t;
                            //   requestAnimationFrame(render);
                            //   ring.setAttribute('color', colors[t]);
                            // }
                            // render();

                        }
                     }   
                }, 1000);
            }
        }
    </script>

</head>
<body onload=start()>
    <a-scene id = "scene">
        {{scene}}
    </a-scene>
    <div id="graph" style="display: none;">
        {{graph}}
    </div>
</body>
</html>
