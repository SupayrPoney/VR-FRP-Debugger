<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
    {{title}}
    </title>
    <meta name="description" content="Hello, World! - A-Frame">
    <!-- AFRAME -->
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <!-- <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.3.1/dist/aframe-extras.misc.min.js"></script> --><!-- For controllers -->
    <script src="https://rawgit.com/andreasplesch/aframe-meshline-component/master/dist/aframe-meshline-component.min.js"></script>
    <script src="https://rawgit.com/ngokevin/aframe-animation-component/master/dist/aframe-animation-component.min.js"></script>
    <script src="https://rawgit.com/protyze/aframe-alongpath-component/master/dist/aframe-alongpath-component.min.js"></script>
    <script src="https://unpkg.com/aframe-controller-cursor-component@0.2.2/dist/aframe-controller-cursor-component.min.js"></script>

    <!-- COMPONENTS -->
    <script src="components/cursor-listener.js" charset="utf-8"></script>
    <!-- <script src="https://rawgit.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script> -->
    
    <!-- HELPERS -->
    <script type="text/javascript" src="./helpers.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script src="lib/codemirror.js"></script>
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="stylesheets/monokai.css">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="stylesheets/main.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script type="text/javascript" src="./vendor/peg.js"></script>

    <script type="text/javascript" charset="utf-8">
        var signalGraph = "";
        var codeMirror;
        function sleep(milliseconds) {
            var start = new Date().getTime();
            for (var i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds){
                    break;
            }
          }
        }
        function findSignalNode(signalGraph, signalName) {
            function searchInNode(node, signalName) {
                // //console.log(node);
                if (node.ref == signalName) {
                    return node;
                }
                else if (node.children) {
                    var i;
                    var result = null;
                    for(i = 0; result == null && i < node.children.length; i++){
                        result = searchInNode(node.children[i], signalName);
                   }
                   return result;
                }
                return null;
            }
            var i;
            var result = null;
            var keys = Object.keys(signalGraph);
            for (i = 0; result == null && i < keys.length; i++){
                // //console.log(signalGraph);
                if (signalGraph[keys[i]].ref ==signalName ) {
                    result = signalGraph[keys[i]];
                }
                else{
                    result = searchInNode(signalGraph[keys[i]], signalName);
                }
            }
            return result;
        }
        function start() {
            codeMirror = CodeMirror(function (elt) {
                document.querySelector("#codeEditor").parentNode.replaceChild(elt, document.querySelector("#codeEditor"));
            }, {
                value: decodeEntities(document.querySelector("#initCode").innerHTML),
                mode:  "javascript",
                lineNumbers: true
            });
            signalGraph = JSON.parse(document.getElementById("graph").innerHTML);
            //var nodeTest = document.querySelector('#\\3' + 2);
            // nodeTest.setAttribute('bmfont-text', "coucou");

            /*if (typeof(Worker) !== "undefined") {
                if (typeof(w) == "undefined") {
                    w = new Worker("webworker.js");
                } 
            }*/
            handle_signals(signalGraph);
        }

        var secondSignalEnabled = true;
        var signal = "seconds";

        function updateNode(node){
            var sceneEl = document.querySelector('a-scene');
            var reached = false;

            // VALUES FLOWINGs      
            for (var i = 0; i < node.children.length; i++) {
                
                var fromNode = document.querySelector('#\\3' + node.id);
                var toNode = document.querySelector('#\\3' + node.children[i].id);

                var fromDest = fromNode.getAttribute('position');
                var toDest = toNode.getAttribute('position');


                var entityEl = document.createElement('a-entity');
                var dist = {
                    x:(toDest.x - fromDest.x),
                    y:(toDest.y - fromDest.y)
                }

                var division = 3;
                var deltaX = dist.x/division;
                var deltaY = dist.y/division;
                ////console.log(fromNode, fromNode.getAttribute('text'));
                var nodeText = fromNode.getAttribute('text').value.split("\n");
                var slidingText = nodeText[nodeText.length-1];
                ////console.log(nodeText);
                var text_ = "align: center; color: black; font: https://cdn.aframe.io/fonts/Roboto-msdf.json; opacity: 1; side: double; value:" + slidingText +"; width: 8.9; wrapCount: 60.6; wrapPixels: 1500; zOffset: 0.01"
                ////console.log(text_);
                entityEl.setAttribute('text', text_);
                entityEl.setAttribute('position', fromDest.x + " " + fromDest.y +" " + fromDest.z)
                // var currentPos = entityEl.getAttribute("position");
                // entityEl.addEventListener('move', function (event) {
                //     sleep(20);
                //     // //console.log("yo")
                // });
                var pathstring = 'path:'
                for (var j = 0; j < division; j++) {
                    pathstring += `${fromDest.x + j*deltaX}` + "," + `${fromDest.y + j*deltaY}` + "," + `${fromDest.z} `
                }
                pathstring += `${toDest.x}` + "," + `${toDest.y}` + "," + `${toDest.z} `
                pathstring += `; closed: false; dur: 10000; loop: false`;
                entityEl.setAttribute("alongpath", pathstring);
                entityEl.setAttribute('class', "flowingText");

                ////console.log(entityEl.getAttribute("alongpath"));

                // for (var i = 0; i < 50; i++) {
                //     // //console.log(fromDest.x-deltaX*i);
                //     entityEl.emit("move")
                    
                // }
                

                // //console.log("From: ");
                // //console.log(fromDest);
                // //console.log("To: ");
                // //console.log(toDest);
                // node.children[i];
                if (entityEl) {
                    sceneEl.appendChild(entityEl);
                }
            }
            
            var circle = document.querySelector("[id='"+ node.id + "0000"+ "']"); //#\\3' + node.id + "0000");
            // //console.log(circle);//'#\\320000');// + node.id + "0000");
            //render('blue');

            var nodeTest = document.querySelector('#\\3' + node.id);
            // //console.log('#\\3' + node.id);
            var nodeText = nodeTest.getAttribute('text').value;
            // //console.log(nodeText.split(" ")[0]);
            var newNodeText = "align: center; color: black; font: https://cdn.aframe.io/fonts/Roboto-msdf.json; opacity: 1; side: double; value:" + node.name +'\n\n'+ node.value.toString() +"; width: 8.9; wrapCount: 60.6; wrapPixels: 1500; zOffset: 0.01"
            //"text:" + ;//nodeTest.setAttribute('bmfont-text',
            nodeTest.setAttribute('text', newNodeText);


            //render('black');
            // var t = 0;
            // var colors = ['black',"orange"]
            // function render() {
            //   t = 1- t;
            //   requestAnimationFrame(render);
            //   ring.setAttribute('color', colors[t]);
            // }
            // render();
        }

        function update_children(parentNode, graph){
            // //console.log("Cocou",graph);
            if (parentNode.children) {
                for (var i = 0; i < parentNode.children.length; i++) {
                    node = parentNode.children[i];
                    switch(node.name){
                        case "fold":
                            node.value = eval(node.formula.replace("$$signalValue$$",parentNode.value).replace("currentValue",node.value)) + node.initValue;
                            updateNode(node);
                            break;
                        case "map":
                            [body,param] = node.formula;
                            node.value = eval(body.replace(param, parentNode.value));
                            updateNode(node);
                            break;
                        case "filter":
                            [body,param] = node.formula;
                            signalValue = parentNode.value
                            if (eval(body.replace(param, signalValue))) {
                                node.value = signalValue;
                            }
                            updateNode(node);
                            break;
                        case "merge":
                            [signal1, signal2, operator] = node.formula;
                            // //console.log(signalGraph);
                            signal1Value = findSignalNode(graph, signal1).value;
                            // //console.log(signal1Value)
                            signal2Value = findSignalNode(graph, signal2).value;
                            node.value = eval(signal1Value + operator + signal2Value);
                            
                            updateNode(node);
                            break;


                    }
                    update_children(node, graph);
                }
            }
        }

        function close_enough_2D(pos1,pos2) {
            return (Math.abs(pos1[0]-pos2[0]) < 0.5 && Math.abs(pos1[1]-pos2[1]) < 0.5)
        }
        

        function handle_signals(signalGraph) {
            if (secondSignalEnabled) {
                setInterval(function(){ 
                    signalGraph[signal].value ++;
                    updateNode(signalGraph[signal]);

                    // //console.log(signalGraph);
                    this.update_children(signalGraph[signal], signalGraph);   
                    delete_flowing_values();
                }, 1000);
            }
        }
        function dive() {
            document.getElementById("code").style.display="none";
            document.getElementById("scene").style = null;
        }
        function inject() {
            if (typeof(Worker) !== "undefined") {
                if (typeof(w) == "undefined") {
                    w = new Worker("parse_worker.js");
                    w.onmessage = function(event){
                        // HERE WE GET THE JSON OF THE SIGNAL GRAPH
                        document.getElementById("result").innerHTML = event.data;
                    };
                }
            } else {
                // Sorry! No Web Worker support..
            }
        }

    </script>

</head>
<body style="font-family:monospace" onload=start()>

    <div id="code" class="menu">
        <div id="codeEditor" class="codeEditor">
            
        </div>

        <div class="footer">
            <button class="btn btn-primary fullwidth" style="margin-top: 5px;" disabled="true" onclick="inject()">Inject code</button>
            <button class="btn btn-primary fullwidth" style="margin-top: 5px;" onclick="dive()">Dive</button>
        </div>
    </div>
    <a-scene class="mainContent" id = "scene">
        
        <!-- Hands -->
        <a-entity teleport-controls hand-controls="left" aabb-collider="objects: .node;" grab controller-cursor="color: #000080" if-no-vr-headset="visible: false"></a-entity>
        <a-entity teleport-controls hand-controls="right" aabb-collider="objects: .node;" grab controller-cursor="color: #000080" if-no-vr-headset="visible: false"></a-entity>

        <!-- SKY -->
        <img id="sky_sphere-texture" src="textures/sky_sphere.jpg">
        <a-sky color="#EEEEFF" material="src: #sky_sphere-texture"></a-sky>

        <!-- SCENE -->
        {{scene}}

        <!-- <a-entity class= "node" material="color: white" geometry="primitive: circle ; radius-outer:1; radius-inner:0.97; height: auto" scale="0.9 0.25 2" text="align: center; color: black; font: https://cdn.aframe.io/fonts/Roboto-msdf.json; opacity: 1; side: double; value: map\n\nThis is s test; width: 8.9; wrapCount: 60.6; wrapPixels: 1500; zOffset: 0"></a-entity> -->

       <!--  <a-entity position="" camera="active:false;near:0.01;userHeight:1.2" rotation="" look-controls="" aframe-injected="" data-aframe-inspector="default-camera"></a-entity> -->
        <!-- <a-sky color="#ECECEC"></a-sky> -->
    </a-scene>
    <div id="graph" style="display: none;">
        {{graph}}
    </div>
    <div id="initCode"  style="display: none;">{{code}}</div>
</body>
</html>
